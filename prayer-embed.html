<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أوقات الصلاة - Fuenlabrada</title>
    
    <!-- Tajawal Font -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Rubik Font -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #0b8043;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --text-color: #555;
            --border-color: #e9ecef;
            --mint-green: #e6f7ee;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', 'Rubik', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* استخدام الأرقام الإنجليزية في جميع العناصر */
        * {
            font-variant-numeric: lining-nums;
        }

        .prayer-container {
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            text-align: center;
        }

        .prayer-header {
            margin-bottom: 30px;
        }

        .prayer-title {
            color: var(--primary-color);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .prayer-location {
            color: var(--secondary-color);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .prayer-location i {
            margin-left: 5px;
        }

        .prayer-datetime {
            color: var(--text-color);
            font-size: 0.9rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .date-separator {
            color: var(--border-color);
        }

        .next-prayer-container {
            background: var(--mint-green);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid var(--secondary-color);
        }

        .next-prayer-label {
            color: var(--secondary-color);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .next-prayer-time {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-family: 'Rubik', sans-serif;
        }

        .countdown {
            color: var(--secondary-color);
            font-size: 1.2rem;
            font-weight: 500;
        }

        .prayer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .prayer-item {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .prayer-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .prayer-item.next-prayer {
            border-color: var(--secondary-color);
            background: var(--mint-green);
            transform: translateY(-5px);
        }

        .prayer-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .prayer-name {
            color: var(--secondary-color);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .prayer-time {
            color: var(--primary-color);
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Rubik', sans-serif;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #dc3545;
            background: #f8d7da;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .prayer-container {
                padding: 20px;
                margin: 10px;
            }

            .prayer-title {
                font-size: 1.5rem;
            }

            .next-prayer-time {
                font-size: 2rem;
            }

            .prayer-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .prayer-item {
                padding: 12px;
            }

            .prayer-image {
                width: 50px;
                height: 50px;
            }
        }

        @media (max-width: 480px) {
            .prayer-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="prayer-container">
        <div class="prayer-header">
            <h1 class="prayer-title">أوقات الصلاة</h1>
            <div class="prayer-location">
                <i class="fas fa-map-marker-alt"></i>
                <span id="prayerLocation">Fuenlabrada, Madrid</span>
            </div>
            <div class="prayer-datetime">
                <span id="madridTime">--:--:--</span>
                <span class="date-separator">|</span>
                <span id="hijriDate">--</span>
            </div>
        </div>

        <div class="next-prayer-container">
            <div class="next-prayer-label">الصلاة القادمة</div>
            <div id="nextPrayer" class="next-prayer-time">--:--</div>
            <div class="countdown" id="prayerCountdown">--:--</div>
        </div>

        <div id="prayerContent">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <script>
        // Prayer Times API - مدمج بالكامل
        (function() {
            'use strict';
            
            // إعدادات الموقع
            const PRAYER_CONFIG = {
                location: {
                    latitude: 40.2837,
                    longitude: -3.7944,
                    city: 'Madrid',
                    country: 'Spain',
                    timezone: 'Europe/Madrid'
                },
                apiBase: 'https://api.aladhan.com/v1'
            };

            // Prayer Times API
            const prayerTimesAPI = {
                // الحصول على أوقات الصلاة ليوم محدد
                async getPrayerTimesForDay(date = new Date()) {
                    try {
                        const day = date.getDate();
                        const month = date.getMonth() + 1;
                        const year = date.getFullYear();
                        
                        const { latitude, longitude, timezone } = PRAYER_CONFIG.location;
                        
                        const response = await fetch(
                            `${PRAYER_CONFIG.apiBase}/timings/${day}-${month}-${year}?latitude=${latitude}&longitude=${longitude}&method=3&timezone=${timezone}`
                        );
                        
                        const data = await response.json();
                        
                        if (data.code === 200) {
                            return data.data;
                        } else {
                            throw new Error('Failed to fetch prayer times data');
                        }
                    } catch (error) {
                        console.error('Error fetching prayer times:', error);
                        return null;
                    }
                },

                // تحويل التاريخ الميلادي إلى هجري
                async getHijriDate(gregDate) {
                    try {
                        const date = new Date(gregDate);
                        const formattedDate = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
                        
                        const response = await fetch(`${PRAYER_CONFIG.apiBase}/gToH/${formattedDate}`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.code === 200 && data.data && data.data.hijri) {
                            return data.data.hijri;
                        } else {
                            console.warn("Invalid response from Hijri date API:", data);
                            return null;
                        }
                    } catch (error) {
                        console.error("Error fetching Hijri date:", error);
                        return null;
                    }
                },

                // حساب الوقت المتبقي للصلاة القادمة
                calculateTimeToNextPrayer(timings) {
                    const now = new Date();
                    const madridTime = new Date(now.toLocaleString("en-US", { timeZone: "Europe/Madrid" }));
                    const currentHours = madridTime.getHours();
                    const currentMinutes = madridTime.getMinutes();
                    const currentTimeInMinutes = currentHours * 60 + currentMinutes;

                    const prayers = [
                        { name: 'Fajr', time: timings.Fajr, nameAr: 'الفجر' },
                        { name: 'Dhuhr', time: timings.Dhuhr, nameAr: 'الظهر' },
                        { name: 'Asr', time: timings.Asr, nameAr: 'العصر' },
                        { name: 'Maghrib', time: timings.Maghrib, nameAr: 'المغرب' },
                        { name: 'Isha', time: timings.Isha, nameAr: 'العشاء' }
                    ];

                    let nextPrayer = null;
                    let minutesUntilNextPrayer = Infinity;

                    for (let prayer of prayers) {
                        const [hours, minutes] = prayer.time.split(':').map(Number);
                        const prayerTimeInMinutes = hours * 60 + minutes;
                        const minutesLeft = prayerTimeInMinutes - currentTimeInMinutes;

                        if (minutesLeft > 0 && minutesLeft < minutesUntilNextPrayer) {
                            nextPrayer = prayer;
                            minutesUntilNextPrayer = minutesLeft;
                        }
                    }

                    // إذا لم نجد صلاة قادمة اليوم، فالصلاة القادمة هي فجر الغد
                    if (!nextPrayer) {
                        nextPrayer = prayers[0];
                        const [hours, minutes] = prayers[0].time.split(':').map(Number);
                        const tomorrowFajrMinutes = hours * 60 + minutes;
                        minutesUntilNextPrayer = (24 * 60 - currentTimeInMinutes) + tomorrowFajrMinutes;
                    }

                    return {
                        nextPrayer,
                        minutesUntilNextPrayer
                    };
                },

                // تنسيق العد التنازلي
                formatCountdown(minutes) {
                    const hours = Math.floor(minutes / 60);
                    const remainingMinutes = minutes % 60;
                    
                    if (hours > 0) {
                        return `${hours}ساعة ${remainingMinutes}دقيقة`;
                    }
                    return `${remainingMinutes}دقيقة`;
                }
            };

            // وظائف العرض
            const displayManager = {
                // تحديث أوقات الصلاة
                async updatePrayerTimes() {
                    try {
                        const data = await prayerTimesAPI.getPrayerTimesForDay();
                        if (!data) {
                            throw new Error('Failed to fetch prayer times');
                        }

                        const hijriData = await prayerTimesAPI.getHijriDate(new Date());
                        
                        // تحديث الموقع والتاريخ
                        document.getElementById('prayerLocation').textContent = 'Fuenlabrada, Madrid';
                        
                        if (hijriData) {
                            document.getElementById('hijriDate').textContent = 
                                `${hijriData.day} ${hijriData.month.ar} ${hijriData.year}`;
                        } else {
                            // إذا فشل في الحصول على التاريخ الهجري، اعرض التاريخ الميلادي
                            const today = new Date();
                            const options = { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric',
                                numberingSystem: 'latn' // استخدام الأرقام الإنجليزية
                            };
                            document.getElementById('hijriDate').textContent = 
                                today.toLocaleDateString('ar-SA', options);
                        }

                        // تحديث أوقات الصلاة
                        const timings = data.timings;
                        const prayers = [
                            { name: 'Fajr', time: timings.Fajr, nameAr: 'الفجر', image: 'prayer-images/sob7.png' },
                            { name: 'Dhuhr', time: timings.Dhuhr, nameAr: 'الظهر', image: 'prayer-images/dohr.png' },
                            { name: 'Asr', time: timings.Asr, nameAr: 'العصر', image: 'prayer-images/asr.png' },
                            { name: 'Maghrib', time: timings.Maghrib, nameAr: 'المغرب', image: 'prayer-images/maghrib.png' },
                            { name: 'Isha', time: timings.Isha, nameAr: 'العشاء', image: 'prayer-images/ishaa.png' }
                        ];

                        // حساب الصلاة القادمة
                        const { nextPrayer, minutesUntilNextPrayer } = prayerTimesAPI.calculateTimeToNextPrayer(timings);
                        
                        // تحديث عرض الصلاة القادمة
                        document.getElementById('nextPrayer').textContent = nextPrayer.time;
                        document.getElementById('prayerCountdown').textContent = 
                            prayerTimesAPI.formatCountdown(minutesUntilNextPrayer);

                        // إنشاء شبكة الصلوات
                        const prayerContent = document.getElementById('prayerContent');
                        prayerContent.innerHTML = `
                            <div class="prayer-grid">
                                ${prayers.map(prayer => `
                                    <div class="prayer-item ${prayer.name === nextPrayer.name ? 'next-prayer' : ''}">
                                        <img src="${prayer.image}" alt="${prayer.nameAr}" class="prayer-image">
                                        <div class="prayer-name">${prayer.nameAr}</div>
                                        <div class="prayer-time">${prayer.time}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;

                    } catch (error) {
                        console.error('Error:', error);
                        document.getElementById('prayerContent').innerHTML = `
                            <div class="error-message">
                                <i class="fas fa-exclamation-triangle"></i>
                                حدث خطأ في تحميل أوقات الصلاة. يرجى المحاولة مرة أخرى.
                            </div>
                        `;
                    }
                },

                // تحديث وقت مدريد
                updateMadridTime() {
                    const now = new Date();
                    const madridTime = new Date(now.toLocaleString("en-US", { timeZone: "Europe/Madrid" }));
                    const timeString = madridTime.toLocaleTimeString('ar-SA', { 
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        numberingSystem: 'latn' // استخدام الأرقام الإنجليزية
                    });
                    document.getElementById('madridTime').textContent = timeString;
                },

                // تحديث العد التنازلي
                updateCountdown() {
                    this.updatePrayerTimes();
                }
            };

            // تهيئة التطبيق
            function initializeApp() {
                // تحميل أوقات الصلاة
                displayManager.updatePrayerTimes();
                
                // تحديث الوقت الحالي
                displayManager.updateMadridTime();
                
                // تحديث الوقت كل ثانية
                setInterval(() => displayManager.updateMadridTime(), 1000);
                
                // تحديث أوقات الصلاة والعد التنازلي كل دقيقة
                setInterval(() => displayManager.updateCountdown(), 60000);
            }

            // بدء التطبيق عند تحميل الصفحة
            document.addEventListener('DOMContentLoaded', initializeApp);

            // تصدير للاستخدام العام (اختياري)
            window.PrayerTimesApp = {
                prayerTimesAPI,
                displayManager,
                initializeApp
            };

        })();
    </script>
</body>
</html>
